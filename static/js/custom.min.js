jQuery(document).ready(function($) {

    (function($, sr) {

        // debouncing function from John Hann
        // http://unscriptable.com/index.php/2009/03/20/debouncing-javascript-methods/
        var debounce = function(func, threshold, execAsap) {
                var timeout;

                return function debounced() {
                    var obj = this,
                        args = arguments;

                    function delayed() {
                        if (!execAsap)
                            func.apply(obj, args);
                        timeout = null;
                    };

                    if (timeout)
                        clearTimeout(timeout);
                    else if (execAsap)
                        func.apply(obj, args);

                    timeout = setTimeout(delayed, threshold || 100);
                };
            }
            // smartresize
        jQuery.fn[sr] = function(fn) {
            return fn ? this.bind('resize', debounce(fn)) : this.trigger(sr);
        };
    })(jQuery, 'smartresize');

jQuery.easing['jswing'] = jQuery.easing['swing'];

jQuery.extend( jQuery.easing, {
    // t: current time, b: begInnIng value, c: change In value, d: duration
        
    easeInOutExpo: function (x, t, b, c, d) {
        if (t==0) return b;
        if (t==d) return b+c;
        if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
        return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
    },
});

    var bgTop = function() {
        var navH = $('.header-container').outerHeight(),
            topH = $('.header-top').outerHeight();
            bgFeature = $('.featured-bg').innerWidth();
            bgBlur = $('.header-bg');

        $('.header-container').css('margin-top', topH + 16 + 'px');
        $('.header-bg').css('height', navH + topH + 22 + 'px').css('background-size', bgFeature + 'px');
        $('.header-of').css('height', navH + topH + 16 + 'px');
        $('.header-ol').css('height', navH + topH + 16 + 'px');

        // TODO: add IE function for blurring
    };

   function myLiveEventHandler(event) {

       if(event.handled !== true)
       {
            // put your payload here.
            var tg = $(this).children('.fa');
            if (tg.hasClass("fa-chevron-down")) {
                tg.removeClass("fa-chevron-down");
                tg.addClass("fa-chevron-right");
            } else {
                tg.removeClass("fa-chevron-right");
                tg.addClass("fa-chevron-down");
            }
            $('.sidebar ul.menu').slideToggle(600);

            event.handled = true;
        }
        return false;
    }

    

    var chevronMenu = function() {
        $.each($('.sidebar h4.widgettitle'), function() {
            if ($(this).children('.fa').length < 1) {
                if ($(this).next('div').children('ul').hasClass('menu')) {
                    $(this).addClass('menu-expand').append("<span class='fa fa-chevron-right'></span>");
                }
            }
        });

        $(".sidebar h4.widgettitle.menu-expand").on('click', myLiveEventHandler); 
    }


    var expandingMenu = function() {

        // TODO : Check screen size and close the whole menu if mobile

        if ($('.sidebar .menu li.menu-item-has-children .sub-menu .current_page_item').length > 0) {
            $(".sidebar .menu li.menu-item-has-children").addClass("is-open");
            $(".sidebar .menu li.menu-item-has-children").children("a").addClass("open");
        }
        /* No longer using expanded child menu
        else {
            $(".sidebar .menu li.menu-item-has-children .sub-menu").css("display", "none");
        }


          $(".sidebar .menu li.menu-item-has-children > a").bind("click", function()
          {

            // See if they clicked the currently open one
            var isOpen = $(this).parent().hasClass("is-open");

            // Close current menu item
            var current = $("div.sidebar .menu li.is-open");
            if (current.length > 0)
            {
              current.removeClass("is-open");
              current.children("a").removeClass("open");
              current.children(".sub-menu").slideUp("normal");
            }

            // Open new menu item (unless they clicked to close)
            if (!isOpen)
            {
              var open = $(this).parent();
              open.addClass("is-open");
              open.children("a").addClass("open");
              open.children(".sub-menu").slideDown("normal");
            }

            // Hide the outline
            $(this).blur();

            return false;

          });
          */
    }


    var galleryBreak = function() {
        $('.gallery').find('br').remove();
    }

    var alerts = function() {
        if ( $('.alerts-all ul').length < 1 ) {
            $('.alert-bar.alert-bar-all.show-alerts').removeClass('.show-alerts');
        }
        else {
            $('.alert-bar.alert-bar-all.show-alerts').slideDown(500, 'easeInOutExpo');
            $('#alert-toggle').addClass('alert-active');
        }

        if ( $('.alerts-park ul').length < 1 ) {
            $('.alert-bar.alert-bar-park.show-alerts').removeClass('.show-alerts');
        }
        else {
            $('.alert-bar.alert-bar-park.show-alerts').slideDown(500, 'easeInOutExpo');
            $('#alert-toggle').addClass('alert-active');
        }

        if ( $('.alerts-home-page ul').length < 1 ) {
            $('.alert-bar.alert-bar-home-page.show-alerts').removeClass('.show-alerts');
        }
        else {
            $('.alert-bar.alert-bar-home-page.show-alerts').slideDown(500, 'easeInOutExpo');
            $('#alert-toggle').addClass('alert-active');
        }

        $('.alert-bar button.close').click(function(){
            var dismissed = this.id;

            $(this).parent($('.alert-bar')).slideUp(500, 'easeInOutExpo').removeClass('show-alerts');

            $.ajax({
                type: "POST",
                url: "/wp-content/themes/mp/user_session.php",
                data: dismissed + '=' + '1',
                success: function(){
                }
            }); 
        })

        $('.alert-active').click(function(e) {
            (e.preventDefault) ? e.preventDefault() : e.returnValue = false;
            if ( $('.alerts-all ul').length > 0 ) {
                $('.alert-bar.alert-bar-all').slideDown(500, 'easeInOutExpo');
            }
            if ( $('.alerts-park ul').length > 0 ) {
                $('.alert-bar.alert-bar-park').slideDown(500, 'easeInOutExpo');   
            }
            if ( $('.alerts-home-page ul').length > 0 ) {
                $('.alert-bar.alert-bar-home-page').slideDown(500, 'easeInOutExpo');   
            }               
        })
    }

    $(".activities-page .activities-menu a").click(function(event) {
        event.preventDefault();
        var targetId = $(this).attr("href").split("#").pop();
        if ($('#' + targetId).hasClass('open')) {
            $('html, body').animate({
                scrollTop: theTarget.offset().top
            }, 1000);
        }
        else {
            $('#' + targetId).trigger("click");
        }

    });

    // If we are on a touch device, hover state dropdown menus can get a little out of control
    function touchDevice() {
        var isTouch = (('ontouchstart' in window) || (navigator.msMaxTouchPoints > 0));
        if (isTouch) {
            $('.menu-top-navigation-container > ul .sub-menu').remove();
            $('.sidebar.touch-menu').addClass('responsive-sidebar').css('display', 'block');
            if ($(window).width() > 768) {
                $('.col-touch-9').addClass('col-md-9');
                $('.col-touch-6').removeClass('col-md-9').addClass('col-md-6');
            }
            else {
                $('.sidebar.touch-menu h4.widgettitle').css('display', 'block');
                $('.sidebar.touch-menu ul.menu').css('display', 'none');
            }
        }
    }

    //Do the expanding menu for smaller devices even if they don't register as touch

    var responsiveMenu = function() {
        if ($(window).width() < 768 || ($('.sidebar.touch-menu.responsive-sidebar').length > 0)) {
            chevronMenu();
        }
    }

    
    touchDevice();
    responsiveMenu();
    expandingMenu();
    bgTop();
    alerts();
    galleryBreak();

    $(window).smartresize(function() {
        responsiveMenu();
        bgTop();
    });

});

setTimeout(function() {
      if (location.hash) {
        window.scrollTo(0, 0);
      }
    }, 1);
